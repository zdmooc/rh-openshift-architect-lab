Semaine 1 – Récap complet (version “cerveau EX280”)

Objectif S1 (socle)
Savoir, uniquement en CLI :

Créer un projet

Déployer une appli simple (deployment)

L’exposer (service + route)

Gérer le scaling

Gérer la configuration (ConfigMap / Secret)

Ajouter probes + ressources

Attacher un PVC et tester la persistance

Brique 1 – Cluster, login, projet

Position plan : Jour 1 – “Prise en main cluster / projets”

Concepts

Contexte oc = cluster + utilisateur + projet courant

oc project = namespace courant

Commandes

# Voir / choisir le projet
oc project
oc projects

# Créer ton projet de labo
oc new-project ex280-lab02

# Vérifier les nodes
oc get nodes


À retenir EX280

Toujours vérifier le projet courant avant de créer des objets (oc project).

Tu dois être à l’aise pour changer de projet, en admin ou en dev.

Brique 2 – Deployment simple HTTPD

Position plan : Jour 1–2 – “Workloads de base (Pod / Deployment)”

Concepts

deployment gère le nombre de pods et les mises à jour

L’image contient Apache HTTPD (UBI)

Commandes

# Création du deployment
oc create deployment httpd-demo \
  --image=registry.access.redhat.com/ubi8/httpd-24 \
  --port=8080

# Vérifier les pods
oc get pods
oc get pods -o wide


À retenir EX280

Savoir créer un deployment via CLI avec oc create deployment.

Savoir retrouver le deployment, les pods et les labels.

Brique 3 – Service + Route

Position plan : Jour 2 – “Exposer l’appli”

Concepts

Service ClusterIP = IP interne stable pour les pods

Route = URL HTTP externe sur OpenShift

Commandes

# Exposer le deployment en service
oc expose deployment httpd-demo --port=8080

# Voir le service
oc get svc
oc describe svc httpd-demo

# Exposer le service en route
oc expose service httpd-demo

# Voir la route
oc get route


Route consultée dans le navigateur :

http://httpd-demo-ex280-lab02.apps-crc.testing


À retenir EX280

oc expose deployment → Service

oc expose service → Route

Savoir trouver l’URL publique avec oc get route.

Brique 4 – Scaling + Endpoints

Position plan : Jour 3 – “Scaling horizontal + Service discovery”

Concepts

replicas = nombre de pods identiques

endpoints = liste IP:port vers les pods cibles du service

Commandes

# Monter à 3 replicas
oc scale deployment httpd-demo --replicas=3

# Vérifier les pods
oc get pods -o wide

# Voir les endpoints du service
oc get endpoints httpd-demo
oc describe svc httpd-demo


À retenir EX280

oc scale deployment <name> --replicas=N

Comprendre que le Service a plusieurs endpoints quand on scale.

Brique 5 – ConfigMap + Secret + variables d’environnement

Position plan : Jour 4 – “Configuration externe”

Concepts

ConfigMap = config non sensible (texte)

Secret = données sensibles (mots de passe, tokens)

Injection via variables d’environnement dans le pod

Commandes

# ConfigMap
oc create configmap httpd-config \
  --from-literal=APP_ENV=ex280-lab02 \
  --from-literal=APP_OWNER=zidane

oc get configmap

# Secret
oc create secret generic httpd-secret \
  --from-literal=APP_PASSWORD=S3cr3t-Ex280

oc get secret

# Injection dans le deployment
oc set env deployment/httpd-demo --from=configmap/httpd-config
oc set env deployment/httpd-demo --from=secret/httpd-secret

# Vérifier
oc set env deployment/httpd-demo --list

# Dans le pod
oc get pods
oc exec -it <POD> -- env | grep APP_


À retenir EX280

oc create configmap et oc create secret generic

oc set env deployment/... --from=configmap/... ou --from=secret/...

Vérifier dans oc exec ... env que les variables sont présentes.

Brique 6 – Probes (readiness / liveness)

Position plan : Jour 5 – “Robustesse appli”

Concepts

Readiness probe : “est-ce que ce pod est prêt à recevoir du trafic ?”

Liveness probe : “est-ce que ce pod est vivant, sinon le redémarrer ?”

HTTP ou TCP ; toi, tu as pratiqué les deux et finalement retenu TCP.

Commandes (TCP)

# Supprimer d’anciennes probes
oc set probe deployment/httpd-demo --readiness --remove
oc set probe deployment/httpd-demo --liveness  --remove

# Probes TCP
oc set probe deployment/httpd-demo \
  --readiness \
  --open-tcp=8080 \
  --initial-delay-seconds=5 \
  --timeout-seconds=2

oc set probe deployment/httpd-demo \
  --liveness \
  --open-tcp=8080 \
  --initial-delay-seconds=10 \
  --timeout-seconds=2

# Vérifier
oc describe deployment httpd-demo | egrep 'Liveness|Readiness'


À retenir EX280

Syntaxe oc set probe (HTTP vs --open-tcp).

Readiness = traffic / Liveness = restart.

Savoir les enlever avec --remove.

Brique 7 – Requests / Limits (ressources)

Position plan : Jour 6 – “Ressources et QoS”

Concepts

requests = minimum garanti (scheduling)

limits = maximum autorisé

Impact sur QoS (Guaranteed / Burstable / BestEffort)

Commandes

oc set resources deployment/httpd-demo \
  --requests=cpu=50m,memory=64Mi \
  --limits=cpu=200m,memory=256Mi

# Vérifier sur le deployment
oc describe deployment httpd-demo | grep -A5 Limits

# Vérifier sur un pod
oc get pods
oc describe pod <POD> | grep -A5 Limits


À retenir EX280

oc set resources deployment/... --requests=... --limits=...

Différence conceptuelle requests / limits.

Brique 8 – PVC + volume + persistance

Position plan : Jour 7 – “Stockage persistant (aperçu)”

Concepts

PVC = demande de stockage

PV = stockage réel

Pod monte un volume basé sur un PVC

Données survivent à la recréation du pod

YAML PVC

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-httpd-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: crc-csi-hostpath-provisioner


Commandes

# Créer le PVC
oc apply -f pvc-httpd-data.yaml
oc get pvc

# Attacher le PVC au deployment
oc set volume deployment/httpd-demo \
  --add \
  --name=httpd-data \
  --type=persistentVolumeClaim \
  --claim-name=pvc-httpd-data \
  --mount-path=/var/www/html/data   # (Git Bash l’a réécrit, mais principe OK)

oc describe deployment httpd-demo | grep -A5 "Volumes"
oc get pvc


Test de persistance (dans ton cas, chemin réécrit par Git Bash)

# Pod 1 : écrire le fichier sur le volume
oc exec -it httpd-demo-7cbbfc5f45-lb29c -- sh -c "\
echo 'EX280 PVC OK' > '/C:/Program Files/Git/var/www/html/data/test.txt'; \
ls -l '/C:/Program Files/Git/var/www/html/data'; \
cat '/C:/Program Files/Git/var/www/html/data/test.txt' \
"

# Supprimer le pod
oc delete pod httpd-demo-7cbbfc5f45-lb29c
oc get pods   # nouveau pod Running

# Pod 2 : vérifier que le fichier existe toujours
oc exec -it httpd-demo-7cbbfc5f45-c2rvf -- sh -c "\
ls -l '/C:/Program Files/Git/var/www/html/data'; \
cat '/C:/Program Files/Git/var/www/html/data/test.txt' \
"
# → EX280 PVC OK


À retenir EX280 (sans le bug Git Bash)

Créer un PVC.

L’attacher à un Deployment (oc set volume).

Dans le pod :

écrire un fichier sur le chemin monté,

supprimer le pod,

vérifier que le fichier est toujours là dans le nouveau pod.