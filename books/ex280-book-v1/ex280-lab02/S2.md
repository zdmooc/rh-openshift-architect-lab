10. Semaine 2 – Labels, annotations, LimitRange, ResourceQuota

Objectif fin S2 :

Être capable, en ligne de commande uniquement, de :

Organiser les ressources avec des labels (app/env/tier/owner) et des annotations métier.

Utiliser les filtres -l, -L, --field-selector pour naviguer dans un projet chargé.

Mettre en place un LimitRange pour définir des requests/limits par défaut.

Mettre en place un ResourceQuota pour contrôler le budget CPU/mémoire/nombre de pods.

Comprendre l’impact concret de ces politiques sur la création / scalabilité des pods.

Environnement de référence :

Cluster CRC local (OpenShift v4.x)

Projet S2 : ex280-lab02

Déploiement applicatif existant : httpd-demo (image registry.access.redhat.com/ubi8/httpd-24, port 8080)

10.1. Brique 1 – Labels & selectors : inventaire et ajout métier

Position dans le plan : Semaine 2, jours 1–2.

Objectif : voir les labels existants, en ajouter de nouveaux et vérifier leur propagation aux pods.

10.1.1. Inspecter les labels existants
oc project ex280-lab02

oc get pods --show-labels
oc get svc --show-labels
oc get deploy --show-labels


Points à observer :

Le pod httpd-demo-... a au moins app=httpd-demo.

Le Service httpd-demo et le Deployment httpd-demo partagent ce label.

10.1.2. Ajouter des labels “métier” sur le Deployment
oc label deploy httpd-demo env=dev tier=frontend owner=zidane --overwrite
oc get deploy httpd-demo --show-labels


Résultat typique :

NAME         READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
httpd-demo   1/1     1            1           ...   app=httpd-demo,env=dev,owner=zidane,tier=frontend

10.1.3. Propager les labels au template de pod

Pour que les pods portent aussi env/tier/owner :

oc patch deployment httpd-demo -p '{
  "spec": {
    "template": {
      "metadata": {
        "labels": {
          "env": "dev",
          "tier": "frontend",
          "owner": "zidane"
        }
      }
    }
  }
}'


Puis :

oc get pods --show-labels


Exemple attendu :

NAME                          READY   STATUS    AGE   LABELS
httpd-demo-xxxxx              1/1     Running   ...   app=httpd-demo,env=dev,owner=zidane,pod-template-hash=...,tier=frontend

10.1.4. Vérifier le selector du Service
oc describe svc httpd-demo


Points à regarder :

Selector: app=httpd-demo

Endpoints: <IP>:8080 → pods correspondants.

10.1.5. Filtrer par labels
oc get pods -l app=httpd-demo
oc get pods -l app=httpd-demo,env=dev,tier=frontend


Notions à retenir :

Labels = organisation logique + filtres (-l), utilisés aussi par les Services/Deployments.

Le selector du Service détermine quels pods reçoivent le trafic.

Modifier spec.template.metadata.labels du Deployment est ce qui impacte réellement les pods.

10.2. Brique 2 – Annotations : documentation des objets

Position dans le plan : Semaine 2, jours 2–3.

Objectif : ajouter des annotations pour documenter les ressources (description, contact).

10.2.1. Ajouter des annotations
oc annotate deploy httpd-demo description="Frontend httpd pour EX280" --overwrite
oc annotate svc httpd-demo support-contact="zidane.djamal@example.com" --overwrite

10.2.2. Vérifier via oc describe
oc describe deploy httpd-demo | sed -n '1,25p'
oc describe svc httpd-demo


Exemples attendus :

Deployment :

Annotations:  deployment.kubernetes.io/revision: ...
              description: Frontend httpd pour EX280


Service :

Annotations:  support-contact: zidane.djamal@example.com


Notions à retenir :

Annotations = métadonnées libres, non utilisées pour filtrer ou router.

Très utiles pour décrire : rôle de la ressource, contact, ticket, URL de doc, etc.

Consultables surtout via oc describe.

10.3. Brique 3 – Listes & filtres avancés (-l, -L, --field-selector)

Position dans le plan : Semaine 2, jours 3–4.

Objectif : savoir combiner labels et fields pour naviguer efficacement dans le namespace.

10.3.1. Afficher les labels en colonnes
oc get pods -L app,env,tier,owner
oc get svc  -L app,env,tier,owner


Exemple :

NAME                          READY   STATUS    AGE   APP          ENV   TIER       OWNER
httpd-demo-...                1/1     Running   ...   httpd-demo   dev   frontend   zidane

10.3.2. Filtres labels (-l)
oc get pods -l app=httpd-demo
oc get pods -l env=dev,tier=frontend
oc get pods -l app=autre-chose   # → "No resources found ..."

10.3.3. Filtres fields (--field-selector)
oc get pods --field-selector status.phase=Running
oc get pods --field-selector status.phase=Pending


Notions à retenir :

-l = filtre sur les labels (métadonnées que tu contrôles).

-L = affiche les labels en colonnes (vue inventaire).

--field-selector = filtre sur des champs internes (ex : status.phase, metadata.name).

Les deux sont complémentaires pour explorer rapidement un projet chargé (cas EX280/EX288).

10.4. Brique 4 – LimitRange : defaults CPU / mémoire

Position dans le plan : Semaine 2, jours 4–5.

Objectif : définir des valeurs par défaut de requests et limits pour les conteneurs qui n’en déclarent pas.

10.4.1. Création d’un LimitRange simple

Fichier YAML :

cat << 'EOF' > limitrange-basic.yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: basic-limits
spec:
  limits:
  - type: Container
    default:
      cpu: "200m"
      memory: "256Mi"
    defaultRequest:
      cpu: "50m"
      memory: "64Mi"
EOF

oc apply -f limitrange-basic.yaml
oc get limitrange
oc describe limitrange basic-limits


Exemple :

Type        Resource  Min  Max  Default Request  Default Limit
----        --------  ---  ---  ---------------  -------------
Container   cpu       -    -    50m              200m
Container   memory    -    -    64Mi             256Mi

10.4.2. Vérifier l’effet sur un nouveau déploiement

Vérifier que httpd-demo a déjà ses propres ressources (donc non impacté par défaut) :

oc describe pod <pod-httpd-demo> | sed -n '/Limits:/,/Environment:/p'


Créer un déploiement sans resources :

oc create deployment demo-nores --image=registry.access.redhat.com/ubi8/httpd-24
oc get pods -l app=demo-nores


Vérifier les ressources du pod :

oc describe pod -l app=demo-nores | sed -n '/Limits:/,/Environment:/p'


Exemple attendu :

Limits:
  cpu:     200m
  memory:  256Mi
Requests:
  cpu:     50m
  memory:  64Mi


Notions à retenir :

LimitRange ne change pas les pods déjà existants, ni ceux qui ont leurs propres resources.

Il s’applique aux nouveaux conteneurs qui n’ont pas de resources → injection automatique des defaultRequest / default.

C’est une première brique de “garde-fou” dans chaque namespace (EX280/EX288).

10.5. Brique 5 – ResourceQuota : budget CPU / mémoire / pods

Position dans le plan : Semaine 2, jours 5–6.

Objectif : définir un budget global de ressources au niveau du namespace et voir comment Kubernetes bloque les dépassements.

10.5.1. Création du ResourceQuota

Fichier YAML :

cat << 'EOF' > resourcequota-basic.yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
spec:
  hard:
    requests.cpu: "200m"
    requests.memory: "256Mi"
    limits.cpu: "500m"
    limits.memory: "640Mi"
    pods: "4"
EOF

oc apply -f resourcequota-basic.yaml
oc get resourcequota
oc describe resourcequota compute-quota


Exemple :

Resource         Used   Hard
--------         ----   ----
limits.cpu       400m   500m
limits.memory    512Mi  640Mi
pods             2      4
requests.cpu     100m   200m
requests.memory  128Mi  256Mi

10.5.2. Dépasser le quota et lire l’erreur

Tentative de création d’un pod supplémentaire :

oc run quota-test --image=registry.access.redhat.com/ubi8/httpd-24 --restart=Never


Erreur attendue (exemple) :

Error from server (Forbidden): pods "quota-test" is forbidden: exceeded quota: compute-quota, requested: limits.cpu=200m,limits.memory=256Mi, used: ..., limited: limits.cpu=500m,limits.memory=640Mi


Vérifications :

oc get pods
oc describe resourcequota compute-quota


Constats :

Le pod quota-test n’est pas créé.

Les valeurs Used n’ont pas changé (la demande a été refusée avant création).

10.5.3. Libérer des ressources et voir Used se mettre à jour
oc scale deployment demo-nores --replicas=0
oc get pods
oc describe resourcequota compute-quota


Constat :

Diminution de pods dans Used.

Diminution de requests.cpu/memory et limits.cpu/memory en fonction des pods restants.

Notions à retenir :

ResourceQuota = budget par namespace (Used vs Hard).

Si une demande (création ou scale) ferait dépasser le budget → l’API renvoie Forbidden (exceeded quota).

Le quota est recalculé dès qu’un pod est créé, supprimé ou scalé.

10.6. Brique 6 – Synthèse Semaine 2

Position dans le plan : Semaine 2, fin de semaine.

Résumé opérationnel à mémoriser :

Labels / selectors

oc get pods --show-labels

oc get pods -L app,env,tier,owner

oc get pods -l app=httpd-demo,env=dev,tier=frontend

Annotations

oc annotate deploy httpd-demo description="..."

oc annotate svc httpd-demo support-contact="..."

Consultation via oc describe ...

LimitRange

YAML kind: LimitRange type Container.

defaultRequest (requests) + default (limits) injectés sur les nouveaux pods sans resources.

oc describe limitrange basic-limits.

ResourceQuota

YAML kind: ResourceQuota.

oc get resourcequota (vue compacte), oc describe resourcequota (Used vs Hard).

Erreur Forbidden en cas de dépassement (exceeded quota: ...).

Dans le projet ex280-lab02, un fichier de mémo a été créé :

recap-semaine2-labels-quotas.txt


qui résume l’ensemble de ces notions et des commandes associées.